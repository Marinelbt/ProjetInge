---
title: "Stat Descriptive"
author: "Amélie Brejot"
date: "2024-12-03"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Importations 


```{r}
library(readr)
library(ggplot2)
library(dplyr)
library(ggpubr)
library(tidyr)
library(stringr)
library(knitr)
library(kableExtra)
```

```{r}
data <- read.csv("../data_final/df_pdfs_final.csv", header = TRUE, sep = ",")

data <- data %>%
  separate(score_final, into = c("score_final_r", "score_final_v"), sep = "-") %>%
  mutate(
    score_final_r = as.integer(score_final_r),
    score_final_v = as.integer(score_final_v)
  ) %>%
  group_by(code_rencontre, club_recevant, coach_recevant, club_visiteur, coach_visiteur, journee, score_final_r, score_final_v, fichier) %>%
  mutate(
    temps_proche_59_min = max(Temps_Sec[Temps_Sec < 59 * 60], na.rm = TRUE),
    statut_59_min_r = first(statut_recevant[Temps_Sec == temps_proche_59_min]),
    statut_59_min_v = -statut_59_min_r,
    score_recevant_59_min = first(score_recevant[Temps_Sec == temps_proche_59_min]),
    score_visiteur_59_min = first(score_visiteur[Temps_Sec == temps_proche_59_min])
  ) %>%
  ungroup() %>% 
  mutate(difference_points = abs(score_recevant - score_visiteur),
         saison = case_when(
           grepl("2021", fichier, ignore.case = TRUE) ~ "2021",
           grepl("2122", fichier, ignore.case = TRUE) ~ "2122",
           grepl("2223", fichier, ignore.case = TRUE) ~ "2223",
           grepl("2324", fichier, ignore.case = TRUE) ~ "2324"
         )) %>% 
  filter(saison != 2425)

data$statut_recevant <- as.factor(data$statut_recevant)

```


# Diagramme nombre de TM par période et par statut
```{r}

data_descr_1 <- data %>%
  filter(abs(score_final_r - score_final_v) <= 2) %>% 
  filter(score_recevant_59_min != score_visiteur_59_min | score_final_r != score_final_v) %>% 
  group_by(fichier) %>%
  mutate(
    periode = case_when(
      Temps_Sec >= 0 & Temps_Sec < 600 ~ 1,  # 0 - 10 minutes
      Temps_Sec >= 600 & Temps_Sec < 1200 ~ 2,  # 10 - 20 minutes
      Temps_Sec >= 1200 & Temps_Sec < 1800 ~ 3,  # 20 - 30 minutes
      Temps_Sec >= 1800 & Temps_Sec < 2400 ~ 4,  # 30 - 40 minutes
      Temps_Sec >= 2400 & Temps_Sec < 3000 ~ 5,  # 40 - 50 minutes
      Temps_Sec >= 3000 ~ 6,  # 50 - 60 minutes
      TRUE ~ NA_real_  # Valeur par défaut pour les autres cas (au cas où)
    )
  ) %>%
  ungroup()

data_pourcentage <- data_descr_1 %>%
  filter(action == "Tem" & action_equipe == "r") %>% 
  group_by(periode) %>%
  summarise(total_periode = n()) %>%
  mutate(pourcentage = total_periode / sum(total_periode) * 100)


if (!"pourcentage" %in% colnames(data)) {
  data_descr_1 <- data_descr_1 %>%
    left_join(data_pourcentage, by = "periode")
}

p1 <- data_descr_1 %>%
  filter(action == "Tem" & action_equipe == "r") %>% 
  ggplot(aes(x = as.factor(periode), fill = statut_recevant)) +
  geom_bar() +
  geom_text(
    aes(
      x = as.factor(periode),
      y = ..count..,  # Utilise le nombre de temps-morts pour positionner les labels
      label = paste0(round(pourcentage, 1), "%")  # Affiche les pourcentages
    ),
    stat = "count",  # Statistique de comptage pour les barres
    inherit.aes = FALSE,  # Empêche l'héritage des esthétiques globales
    vjust = -0.5,  # Place le texte au-dessus des barres
    color = "black",
    size = 5  # Taille du texte des pourcentages
  ) +
  geom_vline(
    xintercept = 3.5,  # Position entre la période 3 et la période 4 (ligne verticale entre 3 et 4)
    linetype = "dashed",  # Style de la ligne (pointillée)
    color = "black",  # Couleur de la ligne
    size = 1  # Taille de la ligne
  ) +
  labs(
    title = "Nombre de temps-morts par période",
    x = "Périodes (1 période = 10 min)",
    y = "Nombre de Temps-Morts",
    fill = "Statut équipe"
  ) +
  scale_fill_manual(
    values = c("-1" = "indianred", "0" = "gray", "1" = "darkolivegreen3"),
    labels = c("-1" = "Perd", "0" = "Égalité", "1" = "Gagne")
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 20, face = "bold"),  # Titre du graphique
    axis.title = element_text(size = 16),                # Titres des axes
    axis.text = element_text(size = 14),                 # Textes des axes
    legend.title = element_text(size = 16),              # Titre de la légende
    legend.text = element_text(size = 14)                # Texte de la légende
  )

p2 <- data_descr_1 %>%
  filter(action == "Tem" & action_equipe == "r") %>% 
  filter(Temps_Sec >= 59 * 60) %>%
  ggplot(aes(x = as.factor(periode), fill = statut_recevant)) +
  geom_bar() +  # Garde les barres en nombre total
  geom_text(
    stat = "count",
    aes(
      label = scales::percent(after_stat(count) / tapply(after_stat(count), ..x.., sum)[as.character(..x..)], accuracy = 1)
    ),
    position = position_stack(vjust = 0.5),  # Empile les labels au centre des segments
    color = "white",
    size = 5  # Taille des textes des pourcentages
  ) +
  labs(
    title = "Nombre de temps-\nmorts à la dernière \nminute",
    x = "59 à 60min (dernière minute)",
    y = "Nombre de Temps-Morts",
    fill = "Statut équipe"
  ) +
  scale_fill_manual(
    values = c("-1" = "indianred", "0" = "gray", "1" = "darkolivegreen3"),
    labels = c("-1" = "Perd", "0" = "Égalité", "1" = "Gagne")
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 20, face = "bold"),  # Titre du graphique
    axis.title = element_text(size = 16),                # Titres des axes
    axis.text = element_text(size = 14),                 # Textes des axes
    legend.title = element_text(size = 16),              # Titre de la légende
    legend.text = element_text(size = 14)                # Texte de la légende
  )

# Combinaison des deux graphiques
graphique_1 <- ggarrange(p1, p2, widths = c(2, 1))

# Enregistrement avec ggsave
ggsave("Graphiques/graphique_desc_1.png", plot = graphique_1, width = 10, height = 6, dpi = 300)


```
 
```{r}
nb_tm_derniere_minute <- data_descr_1 %>%
  filter(Temps_Sec >= 59*60) %>% 
  filter(action == "Tem" & action_equipe == "r") %>% 
  nrow()

nb_tm <- data_descr_1 %>% 
  filter(action == "Tem" & action_equipe == "r") %>%
  nrow()

nb_tm 

nb_tm_derniere_minute * 100 / nb_tm

```

#distribution du nombre de temps-morts selon différence de points 

```{r}

p3 <- ggplot(data = data[data$action == "Tem", ], aes(x = as.factor(difference_points), fill = as.factor(difference_points))) +
  geom_bar(fill = "skyblue") +
  geom_text(
    aes(
      label = scales::percent(..count.. / sum(..count..), accuracy = 1)  
    ),
    stat = "count",  
    position = position_stack(vjust = 0.5),  
    color = "black", 
    size = 3  
  ) +
  labs(
    title = "Nombre de temps-morts par écarts de points",
    x = "Écart de points",
    y = "Nombre de Temps-Morts"
  ) +
  theme_minimal()


p3

p3bis <- p3 <- ggplot(data = data[data$action == "But", ], aes(x = as.factor(difference_points), fill = as.factor(difference_points))) +
  geom_bar(fill = "skyblue") +
  geom_text(
    aes(
      label = scales::percent(..count.. / sum(..count..), accuracy = 1)  
    ),
    stat = "count",  
    position = position_stack(vjust = 0.5),  
    color = "black", 
    size = 3  
  ) +
  labs(
    title = "Distribution des écarts de points",
    x = "Écart de points",
    y = "Fréquence"
  ) +
  theme_minimal()


p3bis

distribution_ecarts <- data %>%
  filter(action == "But") %>% 
  group_by(difference_points) %>%
  summarise(count = n()) %>%
  mutate(
    percentage = count / sum(count),
    type = "fréqence des écarts de points "
  )

distribution_temps_morts <- data %>%
  filter(action == "Tem") %>%
  group_by(difference_points) %>%
  summarise(count = n()) %>%
  mutate(
    percentage = count / sum(count),
    type = "fréquence des prises de temps-morts"
  )

combined_data <- bind_rows(distribution_ecarts, distribution_temps_morts)

p_combined <- ggplot(combined_data, aes(x = as.factor(difference_points), y = percentage, fill = type)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(
    title = "Distribution des écarts de points et des temps-morts",
    x = "Écart de points",
    y = "Fréquence",
    fill = "Type"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 16, face = "bold"),  # Taille et style du titre
    axis.title.x = element_text(size = 14),              # Taille du titre de l'axe X
    axis.title.y = element_text(size = 14),              # Taille du titre de l'axe Y
    axis.text = element_text(size = 12),                 # Taille des étiquettes des axes
    legend.title = element_text(size = 14),              # Taille du titre de la légende
    legend.text = element_text(size = 12),               # Taille des éléments de la légende
    legend.position = c(0.85, 0.85),                     # Position de la légende (x, y)
    legend.justification = c(1, 1)
  ) +
  scale_x_discrete(
    breaks = as.character(seq(0, 30, by = 1))
  )
p_combined


ks.test((distribution_ecarts$difference_points), (distribution_temps_morts$difference_points))


```


#distribution du nombre de temps-morts selon différence de points (dernière minute)


```{r}

p4 <- data %>% 
  filter(action == "Tem" & Temps_Sec >= 59*60) %>% 
  ggplot(aes(x = as.factor(difference_points))) +
  geom_bar(fill = "skyblue") +
  geom_text(
    aes(
      label = scales::percent(..count.. / sum(..count..), accuracy = 1)  
    ),
    stat = "count",  
    position = position_stack(vjust = 0.5),  
    color = "black", 
    size = 3  
  ) +
  geom_vline(
    xintercept = 4.5,  
    linetype = "dashed",  
    color = "black",  
    size = 1  
   ) +
  labs(
    title = "Nombre de temps-morts pris à la dernière minute par écarts de points",
    x = "Écart de points",
    y = "Nombre de Temps-Morts"
  ) +
theme_minimal()

p4


data3 <- data %>%
  group_by(code_rencontre, club_recevant, coach_recevant, club_visiteur, coach_visiteur) %>%
  summarise(temps_proche_59_min = max(Temps_Sec[Temps_Sec < 59 * 60], na.rm = TRUE),
            score_recevant_59_min = first(score_recevant[Temps_Sec == temps_proche_59_min]),
            score_visiteur_59_min = first(score_visiteur[Temps_Sec == temps_proche_59_min]),
            difference_points = abs(score_recevant_59_min - score_visiteur_59_min),
            TM_derniere_min_r = if_else(
              any(Temps_Sec >= 59 * 60 & grepl("tem", action, ignore.case = TRUE) & action_equipe == "r"),
              1, 
              0
              ))


taux_temps_morts_r <- data3 %>%
  group_by(difference_points) %>% 
  summarise(
    taux_temps_morts = mean(TM_derniere_min_r == 1)  # Moyenne des valeurs égales à 1
  ) %>% 
  filter(taux_temps_morts != 0)

p_taux_r <- ggplot(taux_temps_morts_r, aes(x = as.factor(difference_points), y = taux_temps_morts)) +
  geom_bar(fill = "skyblue", stat = "identity", show.legend = FALSE) +
  geom_text(
    aes(label = scales::percent(taux_temps_morts, accuracy = 0.1)), 
    vjust = -0.5, 
    size = 5
  ) +
    geom_vline(
    xintercept = 3.5,  
    linetype = "dashed",  
    color = "black",  
    size = 1  
   ) +
  labs(
    title = "Taux de prises de temps-morts du club recevant\npendant la dernière minute par écart de score à 59 min",
    x = "Écart de score à 59 min",
    y = "Taux de Temps-Morts pris à la derière minute"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5),  # Titre du graphique
    axis.title = element_text(size = 16),                # Titres des axes
    axis.text = element_text(size = 14),                 # Textes des axes
    legend.title = element_text(size = 16),              # Titre de la légende
    legend.text = element_text(size = 14)                # Texte de la légende
  )

p_taux_r

ggsave("Graphiques/graphique_desc_2.png", plot = p_taux_r, width = 10, height = 6, dpi = 300)


```


# Data 5 min avant/après un temps-mort
```{r}
dt_5min_av <- data %>%
  group_by(code_rencontre) %>%
  mutate(
    temps_tem = list(Temps_Sec[action == "Tem"])
  ) %>%
  unnest(temps_tem) %>% # Transformer les listes en colonnes
  filter(
    Temps_Sec < temps_tem & Temps_Sec >= temps_tem - 5 * 60 & action != "Tem"
  ) %>%
  ungroup()

dt_5min_ap <- data %>%
  group_by(code_rencontre) %>%
  mutate(
    temps_tem = list(Temps_Sec[action == "Tem"])
  ) %>%
  unnest(temps_tem) %>%
  filter(
    Temps_Sec > temps_tem & Temps_Sec <= temps_tem + 5 * 60 & action != "Tem"
  ) %>%
  ungroup()
```

```{r}
count_av <- dt_5min_av %>% 
  group_by(action) %>% 
  summarise(count=n())

nb_but_av <- count_av$count[count_av$action == "But"]
nb_tir_av <- count_av$count[count_av$action == "Tir"]
taux_but_av <- round(nb_but_av / (nb_but_av + nb_tir_av)*100,2)
taux_tir_av <- round(nb_tir_av / (nb_but_av + nb_tir_av)*100,2)

count_ap <- dt_5min_ap %>% 
  group_by(action) %>% 
  summarise(count=n())

nb_but_ap <- count_ap$count[count_ap$action == "But"]
nb_tir_ap <- count_ap$count[count_ap$action == "Tir"]
taux_but_ap <- round(nb_but_ap / (nb_but_ap + nb_tir_ap)*100,2)
taux_tir_ap <- round(nb_tir_ap / (nb_but_ap + nb_tir_ap)*100,2)

taux_but_ap
taux_tir_ap

```

```{r}

data2 <- data.frame(
  Category = c("Actions positives", "But", "Actions négatives", "Tir", "Total"),
  N_avant = c("", nb_but_av, "", nb_tir_av, nb_but_av+nb_tir_av),
  Pourc_avant = c("", taux_but_av, "", taux_tir_av, 100),
  #Percent_actions_before = c("", 37.7, "", "", 62.3, "", 100),
  N_apres = c("", nb_but_ap, "", nb_tir_ap, nb_tir_ap+nb_but_ap),
  Pourc_apres = c("", taux_but_ap, "", taux_tir_ap, 100),
  #Percent_actions_after = c("", 46.8, "", "", 53.2, "", 100)
  Comparaison = c("", round(taux_but_ap-taux_but_av,2),"", round(taux_tir_ap-taux_tir_av,2),0)
)

data2 %>%
  kbl(col.names = c("", "N", "%", "N", "%", "ap - av (%)"),
      align = c("l", "c", "c", "c", "c","c")) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F) %>%
  add_header_above(c(" " = 1, "Actions 5min avant un temps_mort" = 2, "Actions 5min après un temps-mort" = 2, "Comparaison" = 1)) %>%
  footnote(general = "N: Nombre d'attaques")

```

```{r}

count <- data %>% 
  group_by(action) %>% 
  summarise(count=n())

nb_but <- count$count[count$action == "But"]
nb_tir <- count$count[count$action == "Tir"]
taux_but <- round(nb_but / (nb_but + nb_tir)*100,2)
taux_tir <- round(nb_tir / (nb_but + nb_tir)*100,2)

data3 <- data.frame(
  Category = c("Actions positives", "But", "Actions négatives", "Tir", "Total"),
  N = c("", nb_but, "", nb_tir, nb_but+nb_tir),
  Pourc = c("", taux_but, "", taux_tir, 100),
  N_apres_tm = c("", nb_but_ap, "", nb_tir_ap, nb_tir_ap+nb_but_ap),
  Pourc_apres_tm = c("", taux_but_ap, "", taux_tir_ap, 100),
  Comparaison = c("", round(taux_but_ap-taux_but,2),"", round(taux_tir_ap-taux_tir,2),0)
)

data3 %>%
  kbl(col.names = c("", "N", "%", "N", "%", "différence (%)"),
      align = c("l", "c", "c", "c", "c","c")) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F) %>%
  add_header_above(c(" " = 1, "Actions pendant toute la durée du match" = 2, "Actions 5min après un temps-mort" = 2, "Comparaison" = 1)) %>%
  footnote(general = "N: Nombre d'attaques")

```

```{r}
dt_1min_ap <- data %>%
  group_by(code_rencontre) %>%
  mutate(
    temps_tem = list(Temps_Sec[action == "Tem"])
  ) %>%
  unnest(temps_tem) %>%
  filter(
    Temps_Sec > temps_tem & Temps_Sec <= temps_tem + 1 * 60 & action != "Tem"
  ) %>%
  ungroup()

count_ap1 <- dt_1min_ap %>% 
  group_by(action) %>% 
  summarise(count=n())

nb_but_ap1 <- count_ap1$count[count_ap1$action == "But"]
nb_tir_ap1 <- count_ap1$count[count_ap1$action == "Tir"]
taux_but_ap1 <- round(nb_but_ap1 / (nb_but_ap1 + nb_tir_ap1)*100,2)
taux_tir_ap1 <- round(nb_tir_ap1 / (nb_but_ap1 + nb_tir_ap1)*100,2)

dt_1min_av <- data %>%
  group_by(code_rencontre) %>%
  mutate(
    temps_tem = list(Temps_Sec[action == "Tem"])
  ) %>%
  unnest(temps_tem) %>% # Transformer les listes en colonnes
  filter(
    Temps_Sec < temps_tem & Temps_Sec >= temps_tem - 1 * 60 & action != "Tem"
  ) %>%
  ungroup()

count_av1 <- dt_1min_av %>% 
  group_by(action) %>% 
  summarise(count=n())

nb_but_av1 <- count_av1$count[count_av1$action == "But"]
nb_tir_av1 <- count_av1$count[count_av1$action == "Tir"]
taux_but_av1 <- round(nb_but_av1 / (nb_but_av1 + nb_tir_av1)*100,2)
taux_tir_av1 <- round(nb_tir_av1 / (nb_but_av1 + nb_tir_av1)*100,2)

data4 <- data.frame(
  Category = c("Actions positives", "But", "Actions négatives", "Tir", "Total"),
  N_avant = c("", nb_but_av1, "", nb_tir_av1, nb_but_av1+nb_tir_av1),
  Pourc_avant = c("", taux_but_av1, "", taux_tir_av1, 100),
  #Percent_actions_before = c("", 37.7, "", "", 62.3, "", 100),
  N_apres = c("", nb_but_ap1, "", nb_tir_ap1, nb_tir_ap1+nb_but_ap1),
  Pourc_apres = c("", taux_but_ap1, "", taux_tir_ap1, 100),
  #Percent_actions_after = c("", 46.8, "", "", 53.2, "", 100)
  Comparaison = c("", round(taux_but_ap1-taux_but_av1,2),"", round(taux_tir_ap1-taux_tir_av1,2),0)
)

data4 %>%
  kbl(col.names = c("", "N", "%", "N", "%", "ap - av (%)"),
      align = c("l", "c", "c", "c", "c","c")) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F) %>%
  add_header_above(c(" " = 1, "Actions 1min avant un temps_mort" = 2, "Actions 1min après un temps-mort" = 2, "Comparaison" = 1)) %>%
  footnote(general = "N: Nombre d'attaques")

```


#effets positifs v1

```{r}
data <- read.table("../data_final/df_pdfs_final.csv", header = TRUE, sep = ",")

data <- data %>%
  separate(score_final, into = c("score_final_r", "score_final_v"), sep = "-") %>%
  mutate(
    score_final_r = as.integer(score_final_r),
    score_final_v = as.integer(score_final_v)
  )

data_mod1 <- data %>%
  group_by(code_rencontre, club_recevant, coach_recevant, club_visiteur, coach_visiteur, journee, score_final_r, score_final_v, fichier) %>%
  summarise(temps_proche_59_min = max(Temps_Sec[Temps_Sec < 59 * 60], na.rm = TRUE),
            statut_59_min_r = first(statut_recevant[Temps_Sec == temps_proche_59_min]),
            statut_59_min_v = -statut_59_min_r,
            score_recevant_59_min = first(score_recevant[Temps_Sec == temps_proche_59_min]),
            score_visiteur_59_min = first(score_visiteur[Temps_Sec == temps_proche_59_min]),
            TM_derniere_min_r = if_else(
              any(Temps_Sec >= 59 * 60 & grepl("tem", action, ignore.case = TRUE) & action_equipe == "r"),
              1, 
              0
              ),
            TM_derniere_min_v = if_else(
              any(Temps_Sec >= 59 * 60 & grepl("tem", action, ignore.case = TRUE) & action_equipe == "v"),
              1, 
              0
              ),
            DM_r = if_else(
              any(Temps_Sec >= 57 * 60 & (grepl("2MN", action, ignore.case = TRUE) | grepl("Dis", action, ignore.case = TRUE)) & action_equipe == "r"),
              1, 
              0
              ),
            DM_v = if_else(
              any(Temps_Sec >= 57 * 60 & (grepl("2MN", action, ignore.case = TRUE) | grepl("Dis", action, ignore.case = TRUE)) & action_equipe == "v"),
              1, 
              0
              ),
            .groups = "drop"
            ) %>%
  filter(abs(score_recevant_59_min - score_visiteur_59_min) < 3) %>% 
  pivot_longer(
    cols = c(statut_59_min_r, statut_59_min_v), 
    names_to = "equipe", 
    values_to = "statut_59_min"
  ) %>%
  mutate(
    equipe = case_when(
      equipe == "statut_59_min_r" ~ "R",
      equipe == "statut_59_min_v" ~ "V"
    ),
    statut_final = case_when(
      equipe == "R" & score_final_r > score_final_v ~ 1,
      equipe == "V" & score_final_v > score_final_r ~ 1,
      score_final_v == score_final_r ~ 0,
      equipe == "R" & score_final_r < score_final_v ~ -1,
      equipe == "V" & score_final_v < score_final_r ~ -1,
    ),
    effet_positif = case_when(
      statut_59_min == -1 & (statut_final == 0 | statut_final == 1) ~ 1,
      statut_59_min == 1 & statut_final == 1 ~ 1,
      statut_59_min == 0 & statut_final == 1 ~ 1,
      TRUE ~ 0
    ),
    TM_derniere_min = case_when(
      equipe == "R" & TM_derniere_min_r == 1 ~ 1,
      equipe == "V" & TM_derniere_min_v == 1 ~ 1,
      TRUE ~ 0
    ),
    TM_derniere_min_adverse = case_when(
      equipe == "V" & TM_derniere_min_r == 1 ~ 1,
      equipe == "R" & TM_derniere_min_v == 1 ~ 1,
      TRUE ~ 0
    ),
    HF = case_when(
      grepl("D1F", fichier, ignore.case = TRUE) | grepl("D2F", fichier, ignore.case = TRUE) ~ "F",
      TRUE ~ "H"
    ),
     DM = case_when(
      equipe == "R" & DM_r == 1 ~ 1,
      equipe == "V" & DM_v == 1 ~ 1,
      TRUE ~ 0
    ),
    DM_adverse = case_when(
      equipe == "V" & DM_r == 1 ~ 1,
      equipe == "R" & DM_v == 1 ~ 1,
      TRUE ~ 0
    ),
    division = case_when(
      grepl("D1", fichier, ignore.case = TRUE) ~ "D1",
      grepl("D2", fichier, ignore.case = TRUE) ~ "D2",
      grepl("N1", fichier, ignore.case = TRUE) ~ "N1"
    ),
    saison = case_when(
      grepl("2021", fichier, ignore.case = TRUE) ~ "2021",
      grepl("2122", fichier, ignore.case = TRUE) ~ "2122",
      grepl("2223", fichier, ignore.case = TRUE) ~ "2223",
      grepl("2324", fichier, ignore.case = TRUE) ~ "2324"
    )
  ) %>% 
  select(-c(TM_derniere_min_r, TM_derniere_min_v, DM_r, DM_v, temps_proche_59_min)) %>% 
  ungroup()  %>% 
  filter (saison != 2425)

# On ne garde que l'équipe recevante 
data_mod1 <- data_mod1 %>%
  filter(equipe == "R") %>% 
  filter(statut_59_min != 0 | statut_final != 0)

data_summary <- data_mod1 %>%
  group_by(statut_59_min, TM_derniere_min, TM_derniere_min_adverse) %>%
  summarise(
    positif = sum(effet_positif == 1),
    negatif = sum(effet_positif == 0),
    .groups = "drop"  # Évite les messages de regroupement
  ) %>%
  mutate(
    total = positif + negatif,  # Calcule le total pour chaque groupe
    pourcentage_positif = positif / total * 100,  # Calcule le pourcentage positif
    fleche = case_when(
      TM_derniere_min == 1 & TM_derniere_min_adverse == 0 & statut_59_min == -1 ~ " ↑",
      TM_derniere_min == 1 & TM_derniere_min_adverse == 0 & statut_59_min == 0 ~ " ↓",
      TM_derniere_min == 1 & TM_derniere_min_adverse == 0 & statut_59_min == 1 ~ " ↓",
      TM_derniere_min == 0 & TM_derniere_min_adverse == 1 & statut_59_min == -1 ~ " ↑",
      TM_derniere_min == 0 & TM_derniere_min_adverse == 1 & statut_59_min == 0 ~ " ↑",
      TM_derniere_min == 0 & TM_derniere_min_adverse == 1 & statut_59_min == 1 ~ " ↓",
      TM_derniere_min == 1 & TM_derniere_min_adverse == 1 & statut_59_min == -1 ~ " ↑",
      TM_derniere_min == 1 & TM_derniere_min_adverse == 1 & statut_59_min == 0 ~ " ↑",
      TM_derniere_min == 1 & TM_derniere_min_adverse == 1 & statut_59_min == 1 ~ " ↓",
      TRUE ~ ""  # Pas de flèche sinon
    ),
    # Ajouter une colonne combinée pour les facettes
    facet_group = case_when(
      TM_derniere_min == 0 & TM_derniere_min_adverse == 0 ~ "TM: Non,\nTM adversaire: Non",
      TM_derniere_min == 1 & TM_derniere_min_adverse == 0 ~ "TM: Oui,\nTM adversaire: Non",
      TM_derniere_min == 0 & TM_derniere_min_adverse == 1 ~ "TM: Non, \nTM adversaire: Oui",
      TM_derniere_min == 1 & TM_derniere_min_adverse == 1 ~ "TM: Oui, \nTM adversaire: Oui"
    )
  ) %>%
  pivot_longer(cols = c(positif, negatif), names_to = "effet", values_to = "count") %>%
  mutate(
    label_texte = ifelse(effet == "positif", paste0(round(pourcentage_positif, 1), "%", fleche), "")
  )

write_csv(data_summary, "../data/data_descr_effetpos.csv")


# Création du diagramme
plot <- ggplot(data_summary, aes(x = as.factor(statut_59_min), y = count, fill = effet)) +
  geom_bar(stat = "identity", position = "stack") +  # Barres empilées
  scale_fill_manual(values = c("positif" = "darkolivegreen3", "negatif" = "indianred")) +
  geom_text(
    data = data_summary %>% filter(effet == "positif"), 
    aes(
      label = label_texte,
      y = count / 2  
    ),
    color = "black",
    size = 5,
    fontface = "bold"
  ) +
  facet_wrap(~facet_group) +  
  labs(
    title = "Effets positifs des temps-morts pris à la dernière minute,\nselon le statut à 59 min",
    x = "Statut à 59 minutes",
    y = "Effectif (Nombre de matchs)",
    fill = "Effets"
  ) +
  scale_x_discrete(labels = c("-1" = "Perd", "0" = "Égalité", "1" = "Gagne")) + 
  theme_minimal() +
  theme(
    plot.title = element_text(size = 16, face = "bold"),
    axis.title.x = element_text(size = 14),
    axis.title.y = element_text(size = 14),
    axis.text = element_text(size = 12),
    legend.title = element_text(size = 14),
    legend.text = element_text(size = 12),
    strip.text = element_text(size = 12, face = "bold") 
  )

plot


```

#effets positifs v2 

```{r}
data_summary <- data_mod1 %>%
  group_by(statut_59_min, TM_derniere_min, TM_derniere_min_adverse) %>%
  summarise(
    positif = sum(effet_positif == 1),
    total = n(),  # Nombre total de matchs dans chaque groupe
    .groups = "drop"
  ) %>%
  mutate(
    pourcentage_positif = positif / total * 100,
    effectif_label = paste0("(",total,")"),
    case_TM = case_when(
      TM_derniere_min == 0 & TM_derniere_min_adverse == 0 ~ 0,
      TM_derniere_min == 1 & TM_derniere_min_adverse == 0 ~ 1,
      TM_derniere_min == 0 & TM_derniere_min_adverse == 1 ~ 2,
      TM_derniere_min == 1 & TM_derniere_min_adverse == 1 ~ 3
    ),
    case_TM_desc = factor(
      case_TM,
      levels = 0:3,
      labels = c(
        "0: TM: Non, TM Adversaire: Non",
        "1: TM: Oui, TM Adversaire: Non",
        "2: TM: Non, TM Adversaire: Oui",
        "3: TM: Oui, TM Adversaire: Oui"
      )
    )
  )


plot <- ggplot(data_summary, aes(x = as.factor(case_TM), y = pourcentage_positif, fill = case_TM_desc)) +
  geom_bar(stat = "identity", width = 0.5, position = position_dodge(width = 0.7), show.legend = TRUE) +  # Barres plus rapprochées
  geom_text(
    aes(
      label = effectif_label,
      y = pourcentage_positif + 5  # Place le texte au-dessus des barres
    ),
    color = "black",
    size = 4,  # Taille réduite pour plus de lisibilité
    fontface = "bold"
  ) +
  facet_wrap(~statut_59_min, labeller = as_labeller(c("-1" = "Perd", "0" = "Égalité", "1" = "Gagne")), 
             scales = "free_x") +  # Facettes pour chaque statut
  scale_fill_manual(
    values = c("darkolivegreen3", "skyblue", "orange", "indianred"),  # Couleurs personnalisées
    name = "4 cas différents selon les prises de temps-mort",  # Titre de la légende
    labels = levels(data_summary$case_TM_desc)  # Description des cas
  ) +
  labs(
    title = "Effets positifs des temps-morts pris à la dernière minute,\nselon le statut à 59 min",
    x = "4 cas différents selon les prises de temps-mort\n(effectif entre parenthèses)",
    y = "Pourcentage d'effets positifs"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 16, face = "bold"),
    axis.title.x = element_text(size = 14),
    axis.title.y = element_text(size = 14),
    axis.text.x = element_text(size = 12),
    axis.text.y = element_text(size = 12),
    legend.title = element_text(size = 14),
    legend.text = element_text(size = 12),
    strip.text = element_text(size = 12, face = "bold"),  # Titres des facettes
    panel.spacing = unit(2, "lines"),  # Espace entre les facettes
    panel.grid.major.x = element_line(color = "grey80"),
    panel.grid.minor.x = element_line(color = "grey90")
  ) + 
  scale_y_continuous(
    breaks = seq(0,100, by = 10),
    minor_breaks = seq(0,100, by = 2)
  )

plot

ggsave("../Graphiques/graphique_desc_3.png", plot = plot, width = 12, height = 6, dpi = 300)


```



# Tableau disjonctif entre TM et DM

```{r}
data_mod1 <- read.csv("../Data/data_mod1.csv")

table_disj_tm <- as.data.frame(table(data_mod1$TM_derniere_min, data_mod1$TM_derniere_min_adverse))
table_disj_dm <- as.data.frame(table(data_mod1$DM, data_mod1$DM_adverse))

colnames(table_disj_tm) <- c("tm", "tm_adverse", "count")
colnames(table_disj_dm) <- c("dm", "dm_adverse", "count")

print(table_disj_dm)
print(table_disj_tm)
```

#Classement par jour

```{r}
point_jour <- read.csv("../Data/point_jour.csv", header = T, sep = ";", row.names = 1)

point_jour_F <- point_jour %>% filter(HF == 'F') %>% 
  select(-c(J27,J28,J29,J30))
point_jour_H <- point_jour %>% filter(HF == 'H')


# Point par jour de la compétition masculine D1 et D2, 2223 et 2324
for (i in 1:nrow(point_jour_H)){
  if (is.na(point_jour_H$J1[i]) == T){
    point_jour_H$J1[i] <- 0
  }
  for (j in 6:34){  # j = [J2:J6]
    if (is.na(point_jour_H[i,j-1])==T){
      point_jour_H[i,j-1] <- point_jour_H[i,j-2]
      point_jour_H[i,j] <- point_jour_H[i,j] + point_jour_H[i,j-1]
    } else {
      point_jour_H[i,j] <- point_jour_H[i,j] + point_jour_H[i,j-1]
    }
  }
  
  if(is.na(point_jour_H$J30[i])==T){
    point_jour_H$J30[i] <- point_jour_H$J29[i]
  }
}

# Point par jour de la compétition féminine D1 et D2, 2223 et 2324
for (i in 1:nrow(point_jour_F)){
  if (is.na(point_jour_F$J1[i]) == T){
    point_jour_F$J1[i] <- 0
  }
  for (j in 6:30){  # j = [J2:J26]
    if (is.na(point_jour_F[i,j-1])==T){
      point_jour_F[i,j-1] <- point_jour_F[i,j-2]
      point_jour_F[i,j] <- point_jour_F[i,j] + point_jour_F[i,j-1]
    } else {
      point_jour_F[i,j] <- point_jour_F[i,j] + point_jour_F[i,j-1]
    }
  }
  if(is.na(point_jour_F$J26[i])==T){
    point_jour_F$J26[i] <- point_jour_F$J25[i]
  }
  
}


point_jour_F$saison <- factor(point_jour_F$saison)
point_jour_F$division <- factor(point_jour_F$division)

point_jour_H$saison <- factor(point_jour_H$saison)
point_jour_H$division <- factor(point_jour_H$division)

# write.csv(point_jour_F, "point_jour_F.csv")
# write.csv(point_jour_H, "point_jour_H.csv")
```

#Evolution difference de classement par jour

```{r}
##### Evolution difference Femme

summary_df_F <- point_jour_F %>% 
  select(-c("match_joue", "total_point")) %>% 
  group_by(saison, division) %>%
  summarise(across(where(is.numeric), list(Max = max, 
                                           Min = min), 
                   .names = "{.col}_{.fn}")) %>%
  pivot_longer(cols = -c(saison, division), 
               names_to = c("Jour", ".value"), 
               names_pattern = "(.*)_(.*)") %>%  
  mutate (Diff = Max - Min)

summary_df_F$Jour <- factor(summary_df_F$Jour, 
                          levels = unique(summary_df_F$Jour[order(as.numeric(str_extract(summary_df_F$Jour, "\\d+")))]))

ggplot(summary_df_F, aes(x = Jour, group = interaction(saison, division))) +
  geom_line(aes(y = Diff, color = interaction(saison, division))) +
  labs(title = "Évolution dfférence de points entre premier et dernier (F)",
       x = "Journées", y = "Ecarts", color = "Saison-Division") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

#### Evolution difference Homme

summary_df_H <- point_jour_H %>% 
  select(-c("match_joue", "total_point")) %>% 
  group_by(saison, division) %>%
  summarise(across(where(is.numeric), list(Max = max, 
                                           Min = min), 
                   .names = "{.col}_{.fn}")) %>%
  pivot_longer(cols = -c(saison, division), 
               names_to = c("Jour", ".value"), 
               names_pattern = "(.*)_(.*)") %>%  
  mutate (Diff = Max - Min)

summary_df_H$Jour <- factor(summary_df_H$Jour, 
                          levels = unique(summary_df_H$Jour[order(as.numeric(str_extract(summary_df_H$Jour, "\\d+")))]))

ggplot(summary_df_H, aes(x = Jour, group = interaction(saison, division))) +
  geom_line(aes(y = Diff, color = interaction(saison, division))) +
  labs(title = "Évolution dfférence de points entre premier et dernier (H)",
       x = "Journées", y = "Ecarts", color = "Saison-Division") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```